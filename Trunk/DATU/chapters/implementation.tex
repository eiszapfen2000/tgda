\chapter{Implementation}
\label{ch:implementation}

\section{The Projected Grid}
\label{sec_projected_grid}
The projected grid is based on a simple concept: in order to achieve an
uniform distribution of details on the image plane, a uniformly spaced grid is
created in post-perspective space and transformed back to world space.
Figure~\ref{fig:projectedgrid} illustrates the difference between a classic
world space approach and the projected grid.
\begin{figure}[h]
\centering
\subbottom[Classic]
{
\includegraphics[scale=0.75]{figures/ProjectedGridVsWorldSpace.pdf}
\label{fig:subfigprojgrid1}
}
\subbottom[Projected Grid]
{
\includegraphics[scale=0.75]{figures/ProjectedGridUniform.pdf}
\label{fig:subfigprojgrid2}
}
\caption{The image on the left shows an uniform grid in worldspace,
its projection onto the image plane is not uniformly spaced though.
The image on the right on the other hand depicts an uniform grid on
the image plane and its associated non-uniform spaced worldspace
positions.}
\label{fig:projectedgrid}
\end{figure}

% The algorithm used for the projected grid can be broken down into the following
% steps:
% \begin{itemize}
%  \item create a uniformly spaced grid orthogonal to the viewer using normalised
% device coordinates
%  \item transform the grid to worldspace
%  \item project the grid onto the desired base plane
%  \item apply height displacement
%  \item run the grid through the rendering pipeline as usual
% \end{itemize}

\subsection{Coordinate Systems}
\label{sec:coordinate_systems}
Let $\mvec{x}$ be a vector representing the three dimensional carthesian
world space coordinate of a vertex, then
\begin{equation}
 \mvec{w} = \transpose{(\mvecx{x}, \mvecy{x}, \mvecz{x}, 1)}
\end{equation}
where $\mvec{w}$ is a homogeneous world space coordinate of $\mvec{x}$.
Let $\mmat{V}$ be the view matrix and $\mmat{P}$ the projection matrix, then
\begin{equation}
\label{eq:ws_to_cs}
 \mvec{c} = \mmat{P} \mmat{V} \mvec{w}
\end{equation}
where $\mvec{c}$ is the \textit{clip space} coordinate of $\mvec{w}$. For $\mvec{c}$ to
be inside the view frustum defined by $\mmat{P}$, $\mvec{c}$ is required to
meet the following condition
\begin{equation}
\label{eq:cs_bounds}
 \mvecx{c}, \mvecy{c}, \mvecz{c} \in \interval{-\mvecw{c}}{\mvecw{c}}
\end{equation}
where $\mvecw{c}$ is the homogeneous component of $\mvec{c}$. Next, clip space
vertex $\mvec{c}$ is transformed by the \textit{perspective division} as follows
\begin{equation}
\label{eq:cs_to_ndc}
 \mvec{n} = \frac{1}{\mvecw{c}}\transpose{(\mvecx{c}, \mvecy{c}, \mvecz{c})}
\end{equation}
where $\mvec{n}$ corresponds to the \textit{normalised device coordinate},
\textit{NDC} in short, of $\mvec{c}$.
%
%
\begin{figure}
\centering
\subbottom[View Frustum]
{
\includegraphics[width=0.4\textwidth]{figures/ProjectiveFrustum.pdf}
\label{fig:subfig_proj_frustum}
}
\subbottom[Canonical view volume]
{
\includegraphics[width=0.4\textwidth]{figures/CanonicalCube.pdf}
\label{fig:subfig_canonical_view_volume}
}
\caption{Left: An example view frustum in view space. Right: The same view frustum
after applying projection and perspective division.}
\label{fig:proj_frustum_ndc}
\end{figure}
%
%
As one can see, equations~\ref{eq:cs_bounds}
and~\ref{eq:cs_to_ndc} imply
\begin{equation}
\label{eq:ndc_bounds}
 \mvecx{n}, \mvecy{n}, \mvecz{n} \in \interval{-1}{1}
\end{equation}
which defines the space NDC reside in, namely the \textit{canonical view volume},
see Figure~\ref{fig:proj_frustum_ndc}.\\


The projected grid, on the other hand, starts inside the canonical view volume
and needs to transform vertices back to world space. Let $\mvec{n}$ be the
normalised device coordinate of a vertex, then
\begin{equation}
\label{eq:ndc_to_cs}
 \mvec{c} = \transpose{(\mvecx{n}, \mvecy{n}, \mvecz{n}, 1)}
\end{equation}
where $\mvec{c}$ is a valid representation of $\mvec{n}$ in clip space. One may choose
a value for $\mvecw{c}$ different from $1$, making it necessary to scale $\mvecx{n}$,
$\mvecy{n}$ and $\mvecz{n}$ accordingly. Again, let $\mmat{V}$ be the view matrix and
$\mmat{P}$ the projection matrix, then
\begin{equation}
\label{eq:cs_to_wsh}
 \mvec{w} = \inverse{(\mmat{P} \mmat{V})} \mvec{c}
\end{equation}
where $\mvec{w}$ is a homogeneous world space coordinate of $\mvec{c}$. Conversion
to three dimensional carthesian world space is accomplished as follows
\begin{equation}
\label{eq:wsh_to_ws}
 \mvec{x} = \frac{1}{\mvecw{w}}\transpose{(\mvecx{w}, \mvecy{w}, \mvecz{w})}
\end{equation}

\subsection{Projection onto Plane}
As noted before, the vertices of the projected grid are represented as normalised
device coordinates. Assuming the plane the grid shall be projected on is specified
in world space coordinates, the following steps need to be computed for each vertex:
\begin{itemize}
 \item Transform vertex from canonical view volume to world space
 \item Setup vertex specific ray
 \item Intersect ray with target plane to compute actual position
\end{itemize}
Step one is already covered by Section~\ref{sec:coordinate_systems}. Step two
requires to setup a ray for each vertex, which implies both a position and a
direction. The position we already have, but to create a direction we need two
different positions. The solution is rather straightforward: let $\mvec{n}$ be
a \textit{two dimensional} vector representing the \textit{X} and \textit{Y}
components of a position in normalised device coordinates, then
\begin{align}
 \mvec{a} & = (\mvecx{n}, \mvecy{n}, -1, 1)\\
 \mvec{b} & = (\mvecx{n}, \mvecy{n}, +1, 1)
\end{align}
where $\mvec{a}$ corresponds to $\mvec{n}$ on the \textit{near plane} in clip space,
and $\mvec{b}$ to $\mvec{n}$ on the \textit{far plane} in clip space. Let $\mvec{d}$
and $\mvec{e}$ be the carthesian world space positions of $\mvec{a}$ and $\mvec{b}$
respectively, then
\begin{equation}
 \label{eq:proj_grid_ray}
 \mvec{p} = \mvec{d} + t(\mvec{e} - \mvec{d})
\end{equation}
where $\mvec{p}$ represents a ray starting at point $\mvec{d}$, pointing in direction
$(\mvec{e} - \mvec{d})$ with variable parameter $t$ controlling the actual position on
the ray.\\

Step three is about intersecting ray $\mvec{p}$ resulting from step two with the target plane.
We define the target plane using the \textit{Hesse normal form} as follows
\begin{equation}
\label{eq:proj_grid_plane}
 \mvec{p}\transpose{\mvec{n}} - d = 0
\end{equation}
where $\mvec{n}$ is the plane's normal vector with unit length and $d$ the plane's distance
from the origin. Next, we insert $\mvec{p}$ from equation~\ref{eq:proj_grid_ray}
into equation~\ref{eq:proj_grid_plane}, resulting in
%
\begin{gather}
\label{eq:plane_and_ray_intersection}
(\mvec{d} + t(\mvec{e} - \mvec{d})\transpose{\mvec{n}} - d = 0\\
\mvec{d}\transpose{\mvec{n}} + t(\mvec{e} - \mvec{d})\transpose{\mvec{n}} - d = 0\\
\intertext{solve for $t$}
t = \cfrac{d - \mvec{d}\transpose{\mvec{n}}}{(\mvec{e} - \mvec{d})\transpose{\mvec{n}}}
\end{gather}
%
where $t$ in combination with equation~\ref{eq:proj_grid_ray} gives the point of intersection
between the ray and the plane. In case $(\mvec{e} - \mvec{d})\transpose{\mvec{n}} = 0$,
there is no point of intersection because the ray is parallel to the plane.

\subsection{Projector}
\fxnote*{JÃ–SSAS}{Backfiring, etc}

\subsection{Discrete Fourier Transform}
We defined surface elevation as follows in Chapter~\ref{sec:random_amplitudes}:
\begin{equation}
\label{eq:dft_surface_elevation}
\eta(\mvec{x}, t) = 
\sum_{\mvec{k}}\frac{1}{\sqrt{2}}(\xi_r+\mathrm{i}\xi_i)
\sqrt{2\Theta(\mvec{k})\Delta k_x \Delta k_y} 
~\mathrm{e}^{-\mathrm{i}\omega(\mvec{k})t}
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}}
\end{equation}
where both the spatial domain $\mvec{x}$ and the wavevector domain $\mvec{k}$ are
of resolution $N \times N$. $N$ is a natural number, even, and a power of two.
The latter two requirements are concessions to the~\emph{Fast Fourier Transform}
algorithm, which works fastest at such resolutions. We may define the following
two terms based on Equation~\ref{eq:dft_surface_elevation}:
\begin{align}
\label{eq:dft_h0}
h_0(\mvec{k})   &= \frac{1}{\sqrt{2}}(\xi_r+\mathrm{i}\xi_i)\sqrt{2\Theta(\mvec{k})\Delta k_x \Delta k_y} \\
h_0(\mvec{k},t) &= h_0(\mvec{k})~\mathrm{e}^{-\mathrm{i}\omega(\mvec{k})t}
\end{align}
The term $h_0(\mvec{k})$ represents a random generated spectrum based on wave
spectrum $\Theta(\mvec{k})$. The term $h_0(\mvec{k},t)$ takes care of the
animation over time of $h_0(\mvec{k})$. As long as the spatial domain,
the wavevector domain, and the wave spectrum do not change, $h_0(\mvec{k})$
does not change either. Hence, it is necessary to generate $h_0(\mvec{k})$ only once
for a specific set of parameters such as area, resolution, wind and fetch. Thus,
only the exponential responsible for the animation has to be computed for all
frames.
%
\subsubsection{Zero Frequency}
%
\newcommand{\ccellnum}[2]{\cellcolor{#1}\num{#2}}
\newcommand{\mcleft}[2]{\multicolumn{1}{!{\color{#1}\vline}S}{#2}}
\newcommand{\mcright}[2]{\multicolumn{1}{S !{\color{#1}\vline}}{#2}}
\newcommand{\mcleftright}[2]{\multicolumn{1}{!{\color{#1}\vline} S !{\color{#1}\vline}}{#2}}
\colorlet{Q1Color}{cyan!25}
\colorlet{Q2Color}{NavyBlue!50}
\colorlet{Q3Color}{violet!45}
\colorlet{Q4Color}{white}
\colorlet{Line1Color}{blue}
\colorlet{Line2Color}{black}
%
We compute surface elevation in the form of an inverse Discrete Fourier Transform as follows:
\begin{gather*}
\eta(\mvec{x}, t) = \sum_{\mvec{k}}~h_0(\mvec{k},t)~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
\intertext{with}
\mvec{k} = (x,y)\in\{(\alpha\Delta k,\beta\Delta k)|
-\frac{N}{2}\leq\alpha,\beta<\frac{N}{2}\} \\
\Delta k = \frac{2\pi}{L}
\end{gather*}
As one can see, the wavevector $\mvec{k} = (0,0)$ lies at the center of the wavevector domain,
where $\alpha=0$ and $\beta=0$. But actual implementations of the inverse Discrete Fourier Transform
expect the zero wavevector as the first element i.e. at the upper left. The wavevector domain
of such implementations is defined as follows:
\begin{equation*}
\mvec{k} = (x,y)\in\{(\alpha\Delta k,\beta\Delta k)|
0\leq\alpha,\beta<N-1\}
\end{equation*}
We know that the spectrum represents a periodic signal, i.e. it repeats itself at infinity in both directions.
Hence, independent of where the zero frequency is located inside the wavevector domain, we may write:
\begin{align*}
 h_0(\mvec{k}(\alpha\Delta k,\beta\Delta k)) &\equiv h_0(\mvec{k}((\alpha\pm N)\Delta k, \beta\Delta k) \\
					     &\equiv h_0(\mvec{k}(\alpha\Delta k, (\beta\pm N)\Delta k) \\
					     &\equiv h_0(\mvec{k}((\alpha\pm N)\Delta k, (\beta\pm N)\Delta k)
\end{align*}
%
\begin{table}
\footnotesize
\centering
%
\sisetup{
round-mode      = places,
round-precision = 1,
explicit-sign = +,
table-number-alignment=right
}
\setlength{\arrayrulewidth}{2pt}
\setlength{\tabcolsep}{3pt}
%
\begin{tabular}{SSSSSSSS}
\hhline{>{\arrayrulecolor{Line1Color}}*{4}{-}~~}
%
\mcleft{Line1Color}{\ccellnum{Q1Color}{1.36+0.00i}} & \ccellnum{Q1Color}{-1.34+1.24i} & \ccellnum{Q2Color}{-1.04+0.00i} & \mcright{Line1Color}{\ccellnum{Q2Color}{-1.34-1.24i}} & \ccellnum{Q1Color}{1.36+0.00i} & \ccellnum{Q1Color}{-1.34+1.24i} & \ccellnum{Q2Color}{-1.04+0.00i} & \ccellnum{Q2Color}{-1.34-1.24i} \\
\mcleft{Line1Color}{\ccellnum{Q1Color}{0.67-0.65i}} & \ccellnum{Q1Color}{ 0.07+0.37i} & \ccellnum{Q2Color}{ 0.87+0.03i} & \mcright{Line1Color}{\ccellnum{Q2Color}{ 0.71+0.21i}} & \ccellnum{Q1Color}{0.67-0.65i} & \ccellnum{Q1Color}{ 0.07+0.37i} & \ccellnum{Q2Color}{ 0.87+0.03i} & \ccellnum{Q2Color}{ 0.71+0.21i} \\
%
\hhline{>{\arrayrulecolor{Line1Color}}|>{\arrayrulecolor{Q1Color}}-->{\arrayrulecolor{Line2Color}}*{4}{-}>{\arrayrulecolor{Q2Color}}--}
%
\mcleft{Line1Color}{\ccellnum{Q3Color}{1.62+0.00i}} & \ccellnum{Q3Color}{0.04+0.16i} & \mcleft{Line2Color}{\textcolor{red}{\num{9.62+0.0i}}} & \mcright{Line1Color}{\num{0.04-0.16i}} & \ccellnum{Q3Color}{1.62+0.0i} & \mcright{Line2Color}{\ccellnum{Q3Color}{0.04+0.16i}}  & \textcolor{red}{\num{9.62+0.0i}} & \num{0.04-0.16i} \\
\mcleft{Line1Color}{\ccellnum{Q3Color}{0.67+0.65i}} & \ccellnum{Q3Color}{0.71-0.21i} & \mcleft{Line2Color}{                \num{0.87-0.03i}} & \mcright{Line1Color}{\num{0.07-0.37i}} & \ccellnum{Q3Color}{0.67+0.65i} & \mcright{Line2Color}{\ccellnum{Q3Color}{0.71-0.21i}} &                 \num{0.87-0.03i} & \num{0.07-0.37i} \\
%
\hhline{>{\arrayrulecolor{Line1Color}}*{4}{-}>{\arrayrulecolor{Q3Color}}-->{\arrayrulecolor{Line2Color}}|}
%
\ccellnum{Q1Color}{1.36+0.00i} & \ccellnum{Q1Color}{-1.34+1.24i} & \mcleft{Line2Color}{\ccellnum{Q2Color}{-1.04+0.00i}} & \ccellnum{Q2Color}{-1.34-1.24i} & \ccellnum{Q1Color}{1.36+0.00i} & \mcright{Line2Color}{\ccellnum{Q1Color}{-1.34+1.24i}} & \ccellnum{Q2Color}{-1.04+0.00i} & \ccellnum{Q2Color}{-1.34-1.24i} \\
\ccellnum{Q1Color}{0.67-0.65i} & \ccellnum{Q1Color}{ 0.07+0.37i} & \mcleft{Line2Color}{\ccellnum{Q2Color}{ 0.87+0.03i}} & \ccellnum{Q2Color}{ 0.71+0.21i} & \ccellnum{Q1Color}{0.67-0.65i} & \mcright{Line2Color}{\ccellnum{Q1Color}{ 0.07+0.37i}}  & \ccellnum{Q2Color}{ 0.87+0.03i} & \ccellnum{Q2Color}{ 0.71+0.21i} \\
%
\hhline{>{\arrayrulecolor{Q1Color}}-->{\arrayrulecolor{Line2Color}}*{4}{-}>{\arrayrulecolor{Q2Color}}--}
{\ccellnum{Q3Color}{1.62+0.00i}} & \ccellnum{Q3Color}{0.04+0.16i} & {\textcolor{red}{\num{9.62+0.0i}}} & {\num{0.04-0.16i}} & \ccellnum{Q3Color}{1.62+0.0i}  & {\ccellnum{Q3Color}{0.04+0.16i}}  & \textcolor{red}{\num{9.62+0.0i}} & \num{0.04-0.16i} \\
{\ccellnum{Q3Color}{0.67+0.65i}} & \ccellnum{Q3Color}{0.71-0.21i} & {                \num{0.87-0.03i}} & {\num{0.07-0.37i}} & \ccellnum{Q3Color}{0.67+0.65i} & {\ccellnum{Q3Color}{0.71-0.21i}} &                  \num{0.87-0.03i} & \num{0.07-0.37i} \\

\end{tabular}
\caption{Example spectrum ($N = 4$) which consists of four colour-coded quadrants, the zero frequency is in red.
The spectrum repeats itself towards the right and the bottom. Blue frame: spectrum where the zero frequency
is at the center of the wavevector domain. Black frame: spectrum where the zero frequency is at the
upper left of the wavevector domain.}
\label{tab:spectrum_q_repeat}
\end{table}
%
\newsubfloat{table}
\begin{table}
\footnotesize
\setlength{\tabcolsep}{3pt}
\sisetup{
round-mode      = places,
round-precision = 1,
explicit-sign = +,
table-number-alignment=right
}
\subbottom[Zero frequency at the center.]{%
\begin{tabular}{|SSSS|}
\hline
{\ccellnum{Q1Color}{1.36+0.00i}} & \ccellnum{Q1Color}{-1.34+1.24i} & \ccellnum{Q2Color}{-1.04+0.00i} & {\ccellnum{Q2Color}{-1.34-1.24i}} \\
{\ccellnum{Q1Color}{0.67-0.65i}} & \ccellnum{Q1Color}{ 0.07+0.37i} & \ccellnum{Q2Color}{ 0.87+0.03i} & {\ccellnum{Q2Color}{ 0.71+0.21i}} \\
{\ccellnum{Q3Color}{1.62+0.00i}} & \ccellnum{Q3Color}{0.04+0.16i}  & {\textcolor{red}{\num{9.62+0.0i}}} & {\num{0.04-0.16i}} \\
{\ccellnum{Q3Color}{0.67+0.65i}} & \ccellnum{Q3Color}{0.71-0.21i}  & {                \num{0.87-0.03i}} & {\num{0.07-0.37i}} \\
\hline
\end{tabular}
}
\subbottom[Zero frequency at the upper left.]{%
\begin{tabular}{|SSSS|}
\hline
{\textcolor{red}{\num{9.62+0.0i}}} & {\num{0.04-0.16i}} & {\ccellnum{Q3Color}{1.62+0.00i}} & \ccellnum{Q3Color}{0.04+0.16i} \\
{                \num{0.87-0.03i}} & {\num{0.07-0.37i}} & {\ccellnum{Q3Color}{0.67+0.65i}} & \ccellnum{Q3Color}{0.71-0.21i} \\
{\ccellnum{Q2Color}{-1.04+0.00i}}  & {\ccellnum{Q2Color}{-1.34-1.24i}} & {\ccellnum{Q1Color}{1.36+0.00i}} & \ccellnum{Q1Color}{-1.34+1.24i} \\
{\ccellnum{Q2Color}{ 0.87+0.03i}}  & {\ccellnum{Q2Color}{ 0.71+0.21i}} & {\ccellnum{Q1Color}{0.67-0.65i}} & \ccellnum{Q1Color}{ 0.07+0.37i} \\
\hline
\end{tabular}
}
\caption{Swap quadrants diagonally to convert between the two wavevector domains of interest.}
\label{tab:quadrant_swap}
\end{table}
%
Table~\ref{tab:spectrum_q_repeat} depicts such a periodic spectrum, where each instance
of the spectrum is divided into four quadrants. The spectrum always consists of those
four quadrants, independent of where the wavevector domain may begin or end. It is only
the~\emph{layout} of the four quadrants that changes with the wavevector domain.
Table~\ref{tab:quadrant_swap} shows that the conversion from a layout
where the zero frequency is at the center to a layout where the zero
frequency is at the upper left is accomplished by a swap between
diagonally opposite quadrants.

\subsubsection{Symmetry}
%
\colorlet{BorderColor}{gray!10}
\colorlet{CenterColor}{white}
\colorlet{Brak}{blue!25}
%https://www.cv.nrao.edu/course/astr534/FourierTransforms.html
%https://ccrma.stanford.edu/~jos/mdft/Even_Odd_Functions.html
%https://ccrma.stanford.edu/~jos/mdft/mdft.html
%https://web.eecs.umich.edu/~fessler/course/451/l/pdf/c5.pdf
The Fourier Transform of real-valued input is~\emph{hermitian} - the real part of the resulting spectrum
is an~\emph{even} function and the imaginary part is~\emph{odd}. A function $f(n)$ is said to be even if
$f(-n) = f(n)$. On the other hand, a function $f(n)$ is said to be odd if $f(-n) = -f(n)$,
with $f(0) = 0$. Let $\mathcal{F}(k)$ be the Fourier Transform of a real-valued function $f(n)$, then
the following must hold:
\begin{equation}
 \mathcal{F}(-k) = \mathcal{F}(k)^*
\end{equation}
where $*$ denotes the complex conjugate operator. The relation is similar to a centrosymmetric one
with $\mathcal{F}(0)$ as a fixpoint at the center, the only difference is the complex conjugation.


Surface elevation $\eta$ is a real-valued function, therefore its spectrum $h_0$ must be hermitian,
too. We may write
\begin{equation}
 h_0(\mvec{-k},t) = h_0(\mvec{k},t)^*
\end{equation}
where finding wavevector $\mvec{k}$ for its counterpart $-\mvec{k}$ has proven to be non-trivial
for even-sized spectra.
%
%
\begin{table}
\footnotesize
\centering
%
\sisetup{
round-mode      = places,
round-precision = 1,
explicit-sign = +,
table-number-alignment=right
}
\setlength{\arrayrulewidth}{.5pt}
\setlength{\tabcolsep}{3pt}
\subbottom{%
\begin{tabular}{SSSS}
\textcolor{gray!50}{\ccellnum{BorderColor}{1.36+0.00i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{-1.34+1.24i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{-1.04+0.00i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{-1.34-1.24i}} \\
\hhline{>{\arrayrulecolor{BorderColor}}->{\arrayrulecolor{black}}*{3}{-}}
\textcolor{gray!50}{\ccellnum{BorderColor}{0.67-0.65i}} & \mcleft{black}{\ccellnum{CenterColor}{0.07+0.37i}} & {\ccellnum{CenterColor}{0.87+0.03i}}                & \mcright{black}{\ccellnum{CenterColor}{0.71+0.21i}} \\
\textcolor{gray!50}{\ccellnum{BorderColor}{1.62+0.00i}} & \mcleft{black}{\ccellnum{CenterColor}{0.04+0.16i}} & \textcolor{red}{\ccellnum{CenterColor}{9.62+0.0i }} & \mcright{black}{\ccellnum{CenterColor}{0.04-0.16i}} \\
\textcolor{gray!50}{\ccellnum{BorderColor}{0.67+0.65i}} & \mcleft{black}{\ccellnum{CenterColor}{0.71-0.21i}} & {\ccellnum{CenterColor}{0.87-0.03i}}                & \mcright{black}{\ccellnum{CenterColor}{0.07-0.37i}} \\
\hhline{>{\arrayrulecolor{BorderColor}}->{\arrayrulecolor{black}}*{3}{-}}
\end{tabular}
}
\subbottom{%
\begin{tabular}{SSSS}
\textcolor{gray!50}{\ccellnum{BorderColor}{1.36+0.00i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{-1.34+1.24i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{-1.04+0.00i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{-1.34-1.24i}} \\
\hhline{>{\arrayrulecolor{BorderColor}}->{\arrayrulecolor{black}}*{3}{-}}
\textcolor{gray!50}{\ccellnum{BorderColor}{0.67-0.65i}} & \mcleft{black}{\ccellnum{blue!15}  { 0.07+0.37i}} & {\ccellnum{violet!40}{0.87+0.03i}}                  & \mcright{black}{\ccellnum{violet!15}{0.71+0.21i}} \\
\textcolor{gray!50}{\ccellnum{BorderColor}{1.62+0.00i}} & \mcleft{black}{\ccellnum{blue!40}  { 0.04+0.16i}} & \textcolor{red}{\ccellnum{CenterColor}{9.62+0.0i }} & \mcright{black}{\ccellnum{blue!40}  {0.04-0.16i}} \\
\textcolor{gray!50}{\ccellnum{BorderColor}{0.67+0.65i}} & \mcleft{black}{\ccellnum{violet!15}{ 0.71-0.21i}} & {\ccellnum{violet!40}{0.87-0.03i}}                  & \mcright{black}{\ccellnum{blue!15}  {0.07-0.37i}} \\
\hhline{>{\arrayrulecolor{BorderColor}}->{\arrayrulecolor{black}}*{3}{-}}
\end{tabular}
}
\caption{Left: The spectrum $\mathcal{F}(\mvec{k})$ of an even-sized ($N = 4$) and real-valued function $f(\mvec{x})$.
The zero frequency $\mvec{k} = (0,0)$ is at the center, written in red.
Right: The matching pairs $\mathcal{F}(-\mvec{k})=\mathcal{F}(\mvec{k})^*$ of the spectrum are colour-coded. One may notice
that the cells in the top row and in the first column to the left lack such pairing.}
\label{tab:spectrum_k_minusk}
\end{table}
%
%
\begin{table}
\footnotesize
\centering
%
\sisetup{
round-mode      = places,
round-precision = 1,
explicit-sign = +,
table-number-alignment=right
}
\setlength{\arrayrulewidth}{.5pt}
\setlength{\tabcolsep}{3pt}
\subbottom{%
\begin{tabular}{SSSS}
\hline
\mcleft{black}{\ccellnum{CenterColor}{1.36+0.00i}}      & {\ccellnum{blue!15}{-1.34+1.24i}}                       & \ccellnum{CenterColor}{-1.04+0.00i}                     & \mcright{black}{\ccellnum{blue!15}{-1.34-1.24i}} \\ %& {\ccellnum{CenterColor}{1.36+0.00i}}\\
\hhline{>{\arrayrulecolor{black}}|>{\arrayrulecolor{white}}->{\arrayrulecolor{black}}|---}
\mcleftright{black}{\ccellnum{violet!15}{0.67-0.65i}}   & \textcolor{gray!50}{\ccellnum{BorderColor}{0.07+0.37i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{0.87+0.03i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{0.71+0.21i}} \\
\mcleftright{black}{\ccellnum{CenterColor}{1.62+0.00i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{0.04+0.16i}} & \textcolor{red!50} {\ccellnum{BorderColor}{9.62+0.0i }} & \textcolor{gray!50}{\ccellnum{BorderColor}{0.04-0.16i}} \\
\mcleftright{black}{\ccellnum{violet!15}{0.67+0.65i}}   & \textcolor{gray!50}{\ccellnum{BorderColor}{0.71-0.21i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{0.87-0.03i}} & \textcolor{gray!50}{\ccellnum{BorderColor}{0.07-0.37i}} \\
\hhline{>{\arrayrulecolor{black}}-}
\end{tabular}
}
\subbottom{%
\begin{tabular}{|SSSSS|}
\hline
{\ccellnum{red!15}{1.36+0.00i}} & \ccellnum{blue!15}{-1.34+1.24i}                & \ccellnum{CenterColor}{-1.04+0.00i}                       & {\ccellnum{CenterColor}{-1.34-1.24i}} & {\ccellnum{CenterColor}{1.36+0.00i}}\\
\hhline{>{\arrayrulecolor{black}}|>{\arrayrulecolor{white}}->{\arrayrulecolor{black}}--->{\arrayrulecolor{white}}->{\arrayrulecolor{black}}|}
{\ccellnum{violet!15}{0.67-0.65i}} & \mcleft{black}{\ccellnum{BorderColor}{0.07+0.37i}} & {\ccellnum{BorderColor}{0.87+0.03i}}                      & \mcright{black}{\ccellnum{BorderColor}{0.71+0.21i}} & {\ccellnum{CenterColor}{0.67-0.65i}}\\
{\ccellnum{CenterColor}{1.62+0.00i}} & \mcleft{black}{\ccellnum{BorderColor}{0.04+0.16i}} & {\cellcolor{BorderColor}\textcolor{red}{\num{9.62+0.0i}}} & \mcright{black}{\ccellnum{BorderColor}{0.04-0.16i}} & {\ccellnum{CenterColor}{1.62+0.00i}}\\
{\ccellnum{CenterColor}{0.67+0.65i}} & \mcleft{black}{\ccellnum{BorderColor}{0.71-0.21i}} & {\ccellnum{BorderColor}{0.87-0.03i}}                      & \mcright{black}{\ccellnum{BorderColor}{0.07-0.37i}} & {\ccellnum{violet!15}{0.67+0.65i}}\\
\hhline{>{\arrayrulecolor{black}}|>{\arrayrulecolor{white}}->{\arrayrulecolor{black}}--->{\arrayrulecolor{white}}->{\arrayrulecolor{black}}|}
{\ccellnum{CenterColor}{1.36+0.00i}} & \ccellnum{CenterColor}{-1.34+1.24i}                & \ccellnum{CenterColor}{-1.04+0.00i}                       & {\ccellnum{blue!15}{-1.34-1.24i}} & {\ccellnum{red!15}{1.36+0.00i}}\\
\hline
\end{tabular}
}
\caption{}
\label{tab:spectrum_k_minusk_border}
\end{table}
%
%
Let the discretised wavevector domain be zero centered and of even size in both dimensions,
then there is one row and one column of wavevectors $\mvec{k}$ which lack
matching wavevectors $-\mvec{k}$ inside said domain, see Table~\ref{tab:spectrum_k_minusk}.
Again, it is the periodic nature of the spectrum that gives us the solution. If we replicate
the spectrum in both directions, we obtain an additional row and an additional column which
allow us to find matching pairs for all wavevectors, see Table~\ref{tab:spectrum_k_minusk_border}.

% That is, because we employ a Discrete Fourier Transform with even-sized input data
% Two issues. Find matching k for -k is not trivial.
% The spectrum would need both an additional row at the bottom, and an additional column to the right.
% Complex conjugate symmetry / Half-complex transform
% Gradients



\begin{equation}
h_0(\mvec{k}) =
\frac{1}{2}
\frac{1}{\sqrt{2}}(\xi_r+\mathrm{i}\xi_i)
\sqrt{2\Theta(\mvec{k})\Delta k_x \Delta k_y}
\end{equation}

\begin{equation}
 h_0(\mvec{k}, t) =
 h_0(\mvec{k})\mathrm{e}^{-\mathrm{i}\omega(\mvec{k})t}
 + h_0^\ast(\mvec{-k})\mathrm{e}^{\mathrm{i}\omega(\mvec{k})t}
\end{equation}

Let $g(k)$ be the Fourier transform of $f(x)$, then we may write the
backward Fourier transform as follows:
\begin{equation}
 f(x) = \sum_{k}g(k)~\mathrm{e}^{\mathrm{i}kt}
\end{equation}
Note, that we omit the scaling factors involved in the Fourier transform
because in the context of this work they are not needed.
Given the backward Fourier transform, we may compute the derivative of $f(x)$
as follows:
\begin{equation}
  \diff{f(x)}{x} = \sum_{k}\mathrm{i}k~g(k)~\mathrm{e}^{\mathrm{i}kt}
\end{equation}
Let $n \in \mathbb{N}$, then the general rule for derivation is as follows:
\begin{equation}
  \diff[n]{f(x)}{x} = \sum_{k}(\mathrm{i}k)^n~g(k)~\mathrm{e}^{\mathrm{i}kt}
\end{equation}


\begin{align}
 f(\mvec{x}) &= \sum_{\mvec{k}}g(\mvec{k})~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
 \nabla f(\mvec{x}) &= \sum_{\mvec{k}}\mathrm{i}\mvec{k}~g(\mvec{k})~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
 \Rightarrow~&\diffp{f(\mvec{x})}{x} = \sum_{\mvec{k}}\mathrm{i}k_{x}~g(\mvec{k})~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
 &\diffp{f(\mvec{x})}{y} = \sum_{\mvec{k}}\mathrm{i}k_{y}~g(\mvec{k})~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}}
\end{align}

\begin{align}
\nabla\eta(\mvec{x},t) =
\sum_{\mvec{k}}&\mathrm{i}\mvec{k}~h_0(\mvec{k},t)
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
\Rightarrow \frac{d\eta(\mvec{x},t)}{dx} &=
\sum_{\mvec{k}}\mathrm{i}k_x~h_0(\mvec{k},t)
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
\frac{d\eta(\mvec{x},t)}{dy} &=
\sum_{\mvec{k}}\mathrm{i}k_y~h_0(\mvec{k},t)
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}}
\end{align}

\begin{align}
\mvec{d}(\mvec{x},t) =
\sum_{\mvec{k}}&\mathrm{-i}\frac{\mvec{k}}{k}~h_0(\mvec{k},t)
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
\Rightarrow d_x(\mvec{x},t) &=
\sum_{\mvec{k}}\mathrm{-i}\frac{k_x}{k}~h_0(\mvec{k},t)
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}} \\
d_y(\mvec{x},t) &=
\sum_{\mvec{k}}\mathrm{-i}\frac{k_y}{k}~h_0(\mvec{k},t)
~\mathrm{e}^{\mathrm{i}\transpose{\mvec{k}}\mvec{x}}
\end{align}

\newcommand{\mcomplex}[2]{\ensuremath{{#1}{#2}\mathrm{i}}}

\pgfplotstabletypeset[
  sci zerofill,
  every head row/.style={ 
        output empty row,
    }
]
{
0.61000   0.35000   0.36000
0.48000   0.81000   0.71000
0.96000   0.23000   0.88000
}

\def\SP{\hspace{5pt}}

\begin{multline}
\sisetup{
round-mode      = places,
round-precision = 2,
%explicit-sign = +,
}
\small
\left(
\begin{array}{S@{\SP}S@{\SP}S}
\num{0.61} & \num{0.35} & \num{0.36} \\
\num{0.48} & \num{0.81} & \num{0.71} \\
\num{0.96} & \num{0.23} & \num{0.88}
\end{array}
\right) \\
\xrightarrow{FT}
\sisetup{
round-mode      = places,
round-precision = 2,
explicit-sign = +,
}
\left(
\begin{array}{SSS}
\num{ 5.39000 + 0.00000i} & \num{ 0.38000 + 0.48497i} &\num{ 0.38000 - 0.48497i} \\
\num{-0.71500 + 0.06062i} & \num{-0.37000 + 0.36373i} &\num{ 0.75500 + 0.82272i} \\
\num{-0.71500 - 0.06062i} & \num{ 0.75500 - 0.82272i} &\num{-0.37000 - 0.36373i} \\
\end{array}
\right) \\
\Rightarrow
\sisetup{
round-mode      = places,
round-precision = 2,
explicit-sign = +,
}
\left(
\begin{array}{SSS}
\cellcolor{blue!25} \num{-0.37000 - 0.36373i} & \num{-0.71500 - 0.06062i} & \num{ 0.75500 - 0.82272i} \\
\num{ 0.38000 - 0.48497i} & \num{ 5.39000 + 0.00000i} & \num{ 0.38000 + 0.48497i} \\
\num{ 0.75500 + 0.82272i} & \num{-0.71500 + 0.06062i} & \num{-0.37000 + 0.36373i} \\
\end{array}
\right)
\end{multline}

\begin{table}
\small
$
\sisetup{
round-mode      = places,
round-precision = 1,
explicit-sign = +,
}
\left(
\begin{array}{S[table-number-alignment = left]S[table-number-alignment = left]S[table-number-alignment = left]S[table-number-alignment = left]}
\num{ 16.36462 +  0.00000i} & \num{ 0.52990 + 17.57366i} & \num{-4.70974 +  0.00000i} & \num{ 0.52990 - 17.57366i} \\
\num{  5.90265 -  5.02624i} & \num{-7.59064 -  3.96207i} & \num{ 0.36357 +  6.33148i} & \num{ 8.48330 +  4.45058i} \\
\num{-15.80487 +  0.00000i} & \num{ 4.78730 +  4.18503i} & \num{61.78001 +  0.00000i} & \num{ 4.78730 -  4.18503i} \\
\num{  5.90265 +  5.02624i} & \num{ 8.48330 -  4.45058i} & \num{ 0.36357 -  6.33148i} & \num{-7.59064 +  3.96207i} \\
\end{array}
\right)
\Rightarrow
\sisetup{
round-mode      = places,
round-precision = 1,
explicit-sign = +,
}
\left(
\begin{array}{SSS}
\cellcolor{blue!25} \num{-0.37000 - 0.36373i} & \num{-0.71500 - 0.06062i} & \num{ 0.75500 - 0.82272i} \\
\num{ 0.38000 - 0.48497i} & \num{ 5.39000 + 0.00000i} & \num{ 0.38000 + 0.48497i} \\
\num{ 0.75500 + 0.82272i} & \num{-0.71500 + 0.06062i} & \num{-0.37000 + 0.36373i} \\
\end{array}
\right)
$
\caption{LOLZ}
\end{table}



\pgfplotstabletypeset[
    col sep=comma,
    every head row/.style={ 
        output empty row,
    },
    %column style={string type,column type={S[table-format=-1.6]}},%
    columns/x/.style={string type,column type={S[table-format=-1.6]},column type/.add={|}{|}},%
    columns/y/.style={string type,column type={S[table-format=-1.6]}},%
    columns/z/.style={string type,column type={S[table-format=-1.6]},column type/.add={|}{|}},%
]
{
x,y,z
\num{5.39000 + 0.00000i},\num{0.38000 + 0.48497i},\num{0.38000 - 0.48497i}
\num{-0.71500 + 0.06062i},\num{-0.37000 + 0.36373i},\num{0.75500 + 0.82272i}
\num{-0.71500 - 0.06062i},\num{0.75500 - 0.82272i},\num{-0.37000 - 0.36373i}
}

\begin{tabular}{lS[table-format = 3]S[table-format = 3.2]}
\toprule
  \textbf{Bus} & \multicolumn{2}{c}{\textbf{Bus Load (MVA)}} \\
               & {Real} & {Complex} \\
  \midrule
  b1 &  50 &  30.99 \\
  b2 & 170 & 105.35 \\
  b3 & 200 & 123.94 \\
  b4 & 150 &  49.58 \\
  \bottomrule
\end{tabular}


\begin{table}
\small
\setlength{\tabcolsep}{3.5pt} % default value: 6pt
\begin{tabular}{| S[table-number-alignment = left] | S[table-number-alignment = left] | S[table-number-alignment = left] |}
\hline
0.30 & 0.72 & 1.00 \\
\hline
0.07 & 0.14 & 0.38 \\
\hline
0.16 & 0.12 & 0.33 \\
\hline
\end{tabular}
\quad
\sisetup{
round-mode      = places,
round-precision = 3,
}
\begin{tabular}{| S[table-number-alignment = right] | S[table-number-alignment = right] | S[table-number-alignment = right] |}
\hline
\cellcolor{blue!25}        \num{-0.410 - 0.15588i} & \cellcolor{ProcessBlue!50}\num{1.42 - 0.01732i} & \cellcolor{Plum!50}        \num{-0.455 - 0.06062i}\\
\hline
\cellcolor{MidnightBlue!50}\num{-0.815 - 0.6322i}  & \cellcolor{red!50}\num{3.22 + 0.0i}     & \cellcolor{MidnightBlue!50}\num{-0.815 + 0.6322i}\\
\hline
\cellcolor{Plum!50}        \num{-0.455 + 0.06062i} & \cellcolor{ProcessBlue!50}\num{1.42 + 0.01732i} & \cellcolor{blue!25}        \num{-0.410 + 0.15588i}\\
\hline
\end{tabular}
\end{table}

Displacement

Displacement Derivatives
